<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJournal - Finance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-bg: #f8fafc;
            --border-color: #e2e8f0;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--light-bg);
            color: #334155;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 56px;
        }
        
        .sidebar .nav-link {
            color: #64748b;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 10px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card.income {
            border-left-color: var(--success-color);
        }
        
        .stat-card.expense {
            border-left-color: var(--danger-color);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .badge-category {
            background: #e0e7ff;
            color: var(--primary-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: #e0e7ff;
        }
        
        .transaction-income {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .transaction-expense {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-book me-2"></i><strong>MyJournal</strong>
            </a>
            <div class="d-flex align-items-center">
                <span class="text-light me-3">Welcome, <span id="username">User</span></span>
                <a href="/dashboard" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 p-0">
                <div class="sidebar">
                    <div class="p-3">
                        <h6 class="text-uppercase text-muted mb-3">Navigation</h6>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="/finance">
                                    <i class="fas fa-money-bill-wave"></i> Finance
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/pmp">
                                    <i class="fas fa-graduation-cap"></i> PMP Study
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/language">
                                    <i class="fas fa-language"></i> Language
                                </a>
                            </li>
                            <li class="nav-item mt-4">
                                <h6 class="text-uppercase text-muted mb-3">Finance Tools</h6>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="showUploadModal()">
                                    <i class="fas fa-upload"></i> Upload CSV
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="loadTransactions()">
                                    <i class="fas fa-list"></i> View Transactions
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="loadSummary()">
                                    <i class="fas fa-chart-pie"></i> Summary
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="resetCategories()">
                                    <i class="fas fa-redo"></i> Reset Categories
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9 p-4">
                <!-- Stats Cards -->
                <div class="row mb-4" id="statsCards">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card income h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Total Income</h6>
                                        <h3 class="mb-0" id="totalIncome">$0</h3>
                                    </div>
                                    <i class="fas fa-arrow-down text-success fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card expense h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Total Expenses</h6>
                                        <h3 class="mb-0" id="totalExpenses">$0</h3>
                                    </div>
                                    <i class="fas fa-arrow-up text-danger fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Net Balance</h6>
                                        <h3 class="mb-0" id="netBalance">$0</h3>
                                    </div>
                                    <i class="fas fa-balance-scale text-primary fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Transactions</h6>
                                        <h3 class="mb-0" id="totalTransactions">0</h3>
                                    </div>
                                    <i class="fas fa-exchange-alt text-warning fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="row mb-4" id="uploadSection">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-file-upload me-2"></i>Upload Bank Statement
                                </h5>
                                <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFile').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h5>Drop your CSV file here or click to browse</h5>
                                    <p class="text-muted">Supports RBC CSV exports and PDF table extracts</p>
                                    <input type="file" id="csvFile" accept=".csv" hidden>
                                </div>
                                <div class="mt-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="formatType" id="formatAuto" value="auto" checked>
                                        <label class="form-check-label" for="formatAuto">Auto-detect</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="formatType" id="formatRBC" value="rbc_csv">
                                        <label class="form-check-label" for="formatRBC">RBC CSV</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="formatType" id="formatPDF" value="rbc_pdf_table">
                                        <label class="form-check-label" for="formatPDF">PDF Table</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="row" id="transactionsSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-list me-2"></i>Transactions
                                    </h5>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="categoryFilter" style="width: 200px;">
                                            <option value="">All Categories</option>
                                        </select>
                                        <input type="date" class="form-control form-control-sm" id="startDate" style="width: 150px;">
                                        <input type="date" class="form-control form-control-sm" id="endDate" style="width: 150px;">
                                        <button class="btn btn-primary btn-sm" onclick="loadTransactions()">
                                            <i class="fas fa-filter"></i> Filter
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="transactionsTable">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Type</th>
                                                <th>Category</th>
                                                <th>Confirmed</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionsBody">
                                            <!-- Transactions will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <span id="paginationInfo">Showing 0 of 0 transactions</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="prevPage" onclick="changePage(-1)" disabled>
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary ms-2" id="nextPage" onclick="changePage(1)" disabled>
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row" id="chartsSection" style="display: none;">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Income vs Expenses</h5>
                                <canvas id="incomeExpenseChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Top Categories</h5>
                                <canvas id="categoriesChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Transaction</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm">
                        <input type="hidden" id="editTransactionId">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="editDescription" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="text" class="form-control" id="editAmount" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="editCategory">
                                <!-- Categories will be populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editConfirmed">
                                <label class="form-check-label" for="editConfirmed">
                                    Confirm categorization
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                    <h5 id="successMessage">Success!</h5>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 0;
        let pageSize = 10;
        let totalTransactions = 0;
        let categories = [];
        let incomeExpenseChart = null;
        let categoriesChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUsername();
            loadCategories();
            loadSummary();
            
            // Setup file upload
            setupFileUpload();
        });

        function loadUsername() {
            const username = localStorage.getItem('username') || 'User';
            document.getElementById('username').textContent = username;
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('csvFile');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    uploadFile();
                }
            });
            
            fileInput.addEventListener('change', uploadFile);
        }

        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const formatType = document.querySelector('input[name="formatType"]:checked').value;
            
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('format_type', formatType);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/finance/upload-csv', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`${result.message}. ${result.saved_count} transactions saved.`);
                    loadSummary();
                    loadTransactions();
                    fileInput.value = '';
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }

        async function loadSummary() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/finance/summary?period=month', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateStats(data);
                    
                    // Show charts section
                    document.getElementById('chartsSection').style.display = 'flex';
                    
                    // Update charts
                    updateCharts(data);
                }
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        function updateStats(data) {
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalTransactions = 0;
            
            data.summary.forEach(item => {
                if (item.type === 'income') {
                    totalIncome = item.total || 0;
                } else if (item.type === 'expense') {
                    totalExpenses = item.total || 0;
                }
                totalTransactions += item.count || 0;
            });
            
            document.getElementById('totalIncome').textContent = '$' + totalIncome.toFixed(2);
            document.getElementById('totalExpenses').textContent = '$' + totalExpenses.toFixed(2);
            document.getElementById('netBalance').textContent = '$' + (totalIncome - totalExpenses).toFixed(2);
            document.getElementById('totalTransactions').textContent = totalTransactions;
        }

        function updateCharts(data) {
            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            const ctx2 = document.getElementById('categoriesChart').getContext('2d');
            
            // Destroy existing charts
            if (incomeExpenseChart) incomeExpenseChart.destroy();
            if (categoriesChart) categoriesChart.destroy();
            
            // Income vs Expenses chart
            const income = data.summary.find(s => s.type === 'income')?.total || 0;
            const expense = data.summary.find(s => s.type === 'expense')?.total || 0;
            
            incomeExpenseChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Income', 'Expenses'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Categories chart
            const topCategories = data.top_categories.slice(0, 8);
            categoriesChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topCategories.map(c => c.category.split('â€“')[0]),
                    datasets: [{
                        label: 'Amount',
                        data: topCategories.map(c => c.total),
                        backgroundColor: '#667eea',
                        borderColor: '#764ba2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadCategories() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/finance/categories', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    categories = await response.json();
                    const categorySelect = document.getElementById('categoryFilter');
                    const editCategorySelect = document.getElementById('editCategory');
                    
                    // Clear existing options
                    categorySelect.innerHTML = '<option value="">All Categories</option>';
                    editCategorySelect.innerHTML = '';
                    
                    // Add categories
                    categories.forEach(category => {
                        categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                        editCategorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                    });
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function loadTransactions() {
            try {
                const token = localStorage.getItem('token');
                const category = document.getElementById('categoryFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `/api/finance/transactions?limit=${pageSize}&offset=${currentPage * pageSize}`;
                if (category) url += `&category=${encodeURIComponent(category)}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTransactions(data);
                    totalTransactions = data.total;
                    updatePagination();
                    
                    // Show transactions section
                    document.getElementById('transactionsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function displayTransactions(data) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            data.transactions.forEach(trans => {
                const amountClass = trans.type === 'income' ? 'transaction-income' : 'transaction-expense';
                const amountPrefix = trans.type === 'income' ? '+' : '-';
                const category = trans.manual_category || trans.auto_category || 'Uncategorized';
                const confirmedBadge = trans.confirmed ? 
                    '<span class="badge bg-success">Confirmed</span>' : 
                    '<span class="badge bg-warning">Pending</span>';
                
                const row = `
                    <tr>
                        <td>${trans.transaction_date}</td>
                        <td>${trans.description}</td>
                        <td class="${amountClass}">${amountPrefix}$${trans.amount.toFixed(2)}</td>
                        <td><span class="badge ${trans.type === 'income' ? 'bg-success' : 'bg-danger'}">${trans.type}</span></td>
                        <td><span class="badge-category">${category}</span></td>
                        <td>${confirmedBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${trans.id}, '${trans.description}', ${trans.amount}, '${category}', ${trans.confirmed})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteTransaction(${trans.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Update pagination info
            document.getElementById('paginationInfo').textContent = 
                `Showing ${data.transactions.length} of ${data.total} transactions`;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 0 && (newPage * pageSize) < totalTransactions) {
                currentPage = newPage;
                loadTransactions();
            }
        }

        function updatePagination() {
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = ((currentPage + 1) * pageSize) >= totalTransactions;
        }

        function editTransaction(id, description, amount, category, confirmed) {
            document.getElementById('editTransactionId').value = id;
            document.getElementById('editDescription').value = description;
            document.getElementById('editAmount').value = '$' + amount.toFixed(2);
            document.getElementById('editCategory').value = category;
            document.getElementById('editConfirmed').checked = confirmed;
            
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        }

        async function saveCategory() {
            const id = document.getElementById('editTransactionId').value;
            const category = document.getElementById('editCategory').value;
            const confirmed = document.getElementById('editConfirmed').checked;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/finance/transaction/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        manual_category: category,
                        confirmed: confirmed
                    })
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
                    modal.hide();
                    showSuccess('Transaction updated successfully!');
                    loadTransactions();
                    loadSummary();
                } else {
                    throw new Error('Failed to update transaction');
                }
            } catch (error) {
                alert('Failed to save changes: ' + error.message);
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/finance/transaction/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showSuccess('Transaction deleted successfully!');
                    loadTransactions();
                    loadSummary();
                } else {
                    throw new Error('Failed to delete transaction');
                }
            } catch (error) {
                alert('Failed to delete transaction: ' + error.message);
            }
        }

        async function resetCategories() {
            if (!confirm('This will reset categories for all unconfirmed transactions. Continue?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/finance/reset-categories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess(result.message);
                    loadTransactions();
                    loadSummary();
                }
            } catch (error) {
                alert('Failed to reset categories: ' + error.message);
            }
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            setTimeout(() => modal.hide(), 2000);
        }

        // Navigation functions
        function showUploadModal() {
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
